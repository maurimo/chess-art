<html>

<head>
  <title>Chess pieces</title>
  <meta http-equiv="Cache-control" content="max-age=0" />
  <meta http-equiv="Cache-control" content="no-cache" />
  <meta http-equiv="Cache-directive" content="no-cache" />
  <meta http-equiv="Pragma-directive" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta http-equiv="Expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <script src="jszip.min.js"></script>
  <script src="FileSaver.min.js"></script>

  <script src="jquery-3.6.1.min.js"></script>
  <script src="jquery-ui-1.13.2/jquery-ui.min.js"></script>
  <link rel="stylesheet" href="jquery-ui-1.13.2/jquery-ui.min.css">

  <script src="https://cdn.jsdelivr.net/npm/spectrum-colorpicker2/dist/spectrum.min.js"></script>
  <link rel="stylesheet" type="text/css"
    href="https://cdn.jsdelivr.net/npm/spectrum-colorpicker2/dist/spectrum.min.css">

  <script language="JavaScript" type="text/javascript">

    function download(filename, text) {
      var element = document.createElement('a');
      element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
      element.setAttribute('download', filename);

      element.style.display = 'none';
      document.body.appendChild(element);

      element.click();

      document.body.removeChild(element);
    }

    function load_piece(el) {
      $(el).css("visibility", "visible");
      let col = $(el).hasClass('b') ? 'black' : 'white';
      let svg = $(el.getSVGDocument()).find('svg');

      let gradient1 = document.getElementById(col + '-1-colorpicker').value;
      let gradient2 = document.getElementById(col + '-2-colorpicker').value;
      let strokeCol = document.getElementById(col + '-s-colorpicker').value;
      let strokeSize = document.getElementById('stroke-spinner').value;
      let boundarySize = document.getElementById('boundary-spinner').value;
      svg.find('#fillGradient #stop0').css('stop-color', gradient1);
      svg.find('#fillGradient #stop1').css('stop-color', gradient2);
      svg.find('#fill-color').html('.fill-color {fill: ' + gradient1 + '; }');
      svg.find('#stroke-color').html('.stroke-color {stroke: ' + strokeCol + '; }');
      svg.find('#stroke-medium').html('.stroke-medium {stroke-width: ' + strokeSize + '; }');
      svg.find('#stroke-boundary').html('.stroke-boundary {stroke-width: ' + boundarySize + '; }');
    }

    function set_black_gradient_1(hex) {
      let bsvgs = $('.board embed.b').map(function (index, el) { return el.getSVGDocument(); }).find('svg');
      bsvgs.find('#fillGradient #stop0').css('stop-color', hex)
      bsvgs.find('#fill-color').html('.fill-color {fill: ' + hex + '; }');
    }

    function set_black_gradient_2(hex) {
      let bsvgs = $('.board embed.b').map(function (index, el) { return el.getSVGDocument(); }).find('svg');
      bsvgs.find('#fillGradient #stop1').css('stop-color', hex);
    }

    function set_black_stroke(hex) {
      let bsvgs = $('.board embed.b').map(function (index, el) { return el.getSVGDocument(); }).find('svg');
      bsvgs.find('#stroke-color').html('.stroke-color {stroke: ' + hex + '; }');
    }

    function set_white_gradient_1(hex) {
      let wsvgs = $('.board embed.w').map(function (index, el) { return el.getSVGDocument(); }).find('svg');
      wsvgs.find('#fillGradient #stop0').css('stop-color', hex)
      wsvgs.find('#fill-color').html('.fill-color {fill: ' + hex + '; }');
    }

    function set_white_gradient_2(hex) {
      let wsvgs = $('.board embed.w').map(function (index, el) { return el.getSVGDocument(); }).find('svg');
      wsvgs.find('#fillGradient #stop1').css('stop-color', hex);
    }

    function set_white_stroke(hex) {
      let wsvgs = $('.board embed.w').map(function (index, el) { return el.getSVGDocument(); }).find('svg');
      wsvgs.find('#stroke-color').html('.stroke-color {stroke: ' + hex + '; }');
    }

    function set_stroke_size(val) {
      let svgs = $('.board embed').map(function (index, el) { return el.getSVGDocument(); }).find('svg');
      svgs.find('#stroke-medium').html('.stroke-medium {stroke-width: ' + val + '; }')
    }

    function set_boundary_size(val) {
      let svgs = $('.board embed').map(function (index, el) { return el.getSVGDocument(); }).find('svg');
      svgs.find('#stroke-boundary').html('.stroke-boundary {stroke-width: ' + val + '; }')
    }

    function get_svg(id) {
      let svg = $(document.getElementById(id).getSVGDocument()).find('svg');
      return '<?xml version="1.0" encoding="UTF-8" standalone="no"?>\n' + svg[0].outerHTML;
    }

    function piece_onload(event) {
      load_piece(event.target);
    }

    function install_piece_onload() {
      for (let el of $(".board embed")) {
        el.addEventListener('load', piece_onload);
      }
    }

    // note: make sure each piece shows up
    let piece_setup = {
      "A1": "wr",
      "C1": "wb",
      "D1": "wq",
      "E1": "wk",
      "A2": "wp",
      "C2": "wp",
      "E2": "wp",
      "B3": "bp",
      "C3": "wn",
      "D4": "bp",
      "E4": "bp",
      "A5": "br",
      "B5": "bn",
      "C5": "bb",
      "D5": "bq",
      "E5": "bk",
    };

    function get_all_variables() {
      let query = window.location.search.substring(1);
      let vars = query.split("&");
      let retv = {}
      for (let i = 0; i < vars.length; i++) {
        let pair = vars[i].split("=", 2);
        if (pair.length == 2 && pair[0].length > 0) {
          retv[pair[0]] = pair[1];
        }
      }
      return retv;
    }

    function update_variables(var_values) {
      let path = window.location.pathname;
      let all_vars = get_all_variables();
      for (let v in var_values) {
        all_vars[v] = var_values[v];
      }
      let first = true;
      for (let v in all_vars) {
        path += (first ? '?' : '&') + v + "=" + all_vars[v];
        first = false;
      }
      window.history.pushState("Chess Pieces", "", path);
    }

    function get_variable(variable, def) {
      let query = window.location.search.substring(1);
      let vars = query.split("&");
      for (let i = 0; i < vars.length; i++) {
        let pair = vars[i].split("=");
        if (pair[0] == variable) { return pair[1]; }
      }
      return def;
    }

    function load_all_pieces() {
      let set = get_variable('set', 'fantasy');

      for (let sq in piece_setup) {
        let pc = piece_setup[sq];
        let id = "sq" + sq;
        let el = document.getElementById(id);
        el.className = pc[0];
        $(el).css("visibility", "hidden");
        el.src = set + "/" + pc[1] + ".svg";
      }
    }

    $(() => {
      let all_vars = get_all_variables();

      let options = $("#piece-set-select").find("option");
      let all_sets = options.map((i, el) => { return el.value; }).toArray();
      let pset = all_vars["set"] || "fantasy";
      if (all_sets.indexOf(pset) == -1) {
        pset = "fantasy";
      }
      let set_index = all_sets.indexOf(pset);
      options[set_index].selected = "selected"
      $("#piece-set-select").selectmenu({
        change: (event, ui) => {
          update_variables({ "set": ui.item.value });
          load_all_pieces();
          //console.log("change", ui.item.value);
        }
      });

      $("#stroke-spinner").spinner({
        min: 0,
        max: 100,
        change: (event, ui) => {
          set_stroke_size(event.target.value);
          update_variables({ "stroke": event.target.value });
        },
        spin: (event, ui) => {
          set_stroke_size(ui.value);
          update_variables({ "stroke": ui.value })
        },
      }).val(all_vars['stroke'] || 20);

      $("#boundary-spinner").spinner({
        min: 0,
        max: 100,
        change: (event, ui) => {
          set_boundary_size(event.target.value);
          update_variables({ "boundary": event.target.value });
        },
        spin: (event, ui) => {
          set_boundary_size(ui.value);
          update_variables({ "boundary": ui.value });
        },
      }).val(all_vars['boundary'] || 35);

      $("#black-1-colorpicker").spectrum({
        color: all_vars['b1'] || "#877f73",
        showAlpha: false,
        move: (col) => { set_black_gradient_1(col.toHexString()); },
        hide: (col) => { set_black_gradient_1(col.toHexString()); },
        change: (col) => { update_variables({ "b1": col.toHexString().substring(1) }); },
      });

      $("#black-2-colorpicker").spectrum({
        color: all_vars['b2'] || "#303030",
        showAlpha: false,
        move: (col) => { set_black_gradient_2(col.toHexString()); },
        hide: (col) => { set_black_gradient_2(col.toHexString()); },
        change: (col) => { update_variables({ "b2": col.toHexString().substring(1) }); },
      });

      $("#black-s-colorpicker").spectrum({
        color: all_vars['bs'] || "black",
        showAlpha: false,
        move: (col) => { set_black_stroke(col.toHexString()); },
        hide: (col) => { set_black_stroke(col.toHexString()); },
        change: (col) => { update_variables({ "bs": col.toHexString().substring(1) }); },
      });

      $("#white-1-colorpicker").spectrum({
        color: all_vars['w1'] || "white",
        showAlpha: false,
        move: (col) => { set_white_gradient_1(col.toHexString()); },
        hide: (col) => { set_white_gradient_1(col.toHexString()); },
        change: (col) => { update_variables({ "w1": col.toHexString().substring(1) }); },
      });

      $("#white-2-colorpicker").spectrum({
        color: all_vars['w2'] || "#bfd3d7",
        showAlpha: false,
        move: (col) => { set_white_gradient_2(col.toHexString()); },
        hide: (col) => { set_white_gradient_2(col.toHexString()); },
        change: (col) => { update_variables({ "w2": col.toHexString().substring(1) }); },
      });

      $("#white-s-colorpicker").spectrum({
        color: all_vars['ws'] || "black",
        showAlpha: false,
        move: (col) => { set_white_stroke(col.toHexString()); },
        hide: (col) => { set_white_stroke(col.toHexString()); },
        change: (col) => { update_variables({ "ws": col.toHexString().substring(1) }); },
      });

      $("#download-button").button().click(function () {
        let piece_to_square = {};
        for (let sq in piece_setup) {
          piece_to_square[piece_setup[sq]] = sq;
        }

        let set = get_variable('set', 'fantasy');
        let zip = new JSZip();
        let folder = zip.folder(set);
        for (let pc in piece_to_square) {
          folder.file(pc + ".svg", get_svg('sq' + piece_to_square[pc]));
        }
        zip.generateAsync({ type: "blob" })
          .then((data) => {
            saveAs(data, set + '.zip');
          });
      });

      install_piece_onload();
      load_all_pieces();
    })
  </script>
  <style>
    input {
      box-shadow: none;
      color: inherit;
      border: 1px solid #cccccc;
      border-radius: 4px;
      padding: .5em .8em;
      font-size: inherit;
      font-family: inherit;
      margin-bottom: 10px;
      margin-right: 10px;
      background-color: white;
    }

    input.colorpicker {
      width: 7em;
    }

    table.board {
      border: none;
      margin: 0px;
      padding: 0px;
      border-collapse: collapse;
    }

    .board tr td {
      width: 0%;
      padding: 0px;
      white-space: nowrap;
      width: 150px;
      height: 150px;
    }

    .board embed {
      width: 150px;
      height: 150px;
    }

    .board .light,
    .board .light_lichess {
      background-color: #efdfb1;
    }

    .board .dark,
    .board .dark_lichess {
      background-color: #b68b5d;
    }

    .board .light2,
    .board .light_chesstempo {
      background-color: #dfdfdf;
    }

    .board .dark2,
    .board .dark_chesstempo {
      background-color: #6f71b6;
    }
  </style>
</head>

<body style="text-align: center">
  <h1 style="font-family: Sans; margin-bottom: 0.3em">Chess Pieces</h1>

  <table style="margin: 0 auto">
    <tr>
      <td>
        <table class="board" style="margin: 0 auto; border: 3px solid black">
          <tr>
            <td class="light"><object><embed id='sqA5'></object></td>
            <td class="dark"><object><embed id='sqB5'></object></td>
            <td class="light"><object><embed id='sqC5'></object></td>
            <td class="dark"><object><embed id='sqD5'></object></td>
            <td class="light"><object><embed id='sqE5'></object></td>
          </tr>
          <tr>
            <td class="dark"><object><embed id='sqA4'></object></td>
            <td class="light"><object><embed id='sqB4'></object></td>
            <td class="dark"><object><embed id='sqC4'></object></td>
            <td class="light"><object><embed id='sqD4'></object></td>
            <td class="dark"><object><embed id='sqE4'></object></td>
          </tr>
          <tr>
            <td class="light"><object><embed id='sqA3'></object></td>
            <td class="dark"><object><embed id='sqB3'></object></td>
            <td class="light"><object><embed id='sqC3'></object></td>
            <td class="dark"><object><embed id='sqD3'></object></td>
            <td class="light"><object><embed id='sqE3'></object></td>
          </tr>
          <tr>
            <td class="dark"><object><embed id='sqA2'></object></td>
            <td class="light"><object><embed id='sqB2'></object></td>
            <td class="dark"><object><embed id='sqC2'></object></td>
            <td class="light"><object><embed id='sqD2'></object></td>
            <td class="dark"><object><embed id='sqE2'></object></td>
          </tr>
          <tr>
            <td class="light"><object><embed id='sqA1'></object></td>
            <td class="dark"><object><embed id='sqB1'></object></td>
            <td class="light"><object><embed id='sqC1'></object></td>
            <td class="dark"><object><embed id='sqD1'></object></td>
            <td class="light"><object><embed id='sqE1'></object></td>
          </tr>
        </table>
      </td>
      <td style="padding-left: 2em">
        <p>
          <label for="piece-set-select">Piece set:</label>
          <select name="piece-set" id="piece-set-select">
            <option value="fantasy">Fantasy</option>
            <option value="celtic">Celtic</option>
            <option value="spatial">Spatial</option>
          </select>
        </p>
        <p>
          <label for="stroke-spinner" class="ui-widget ui-state-default" style="border:none; background: none;">Inner
            stroke:</label>
          <input id="stroke-spinner" style="width: 3em" />
        </p>
        <p>
          <label for="boundary-spinner" class="ui-widget ui-state-default"
            style="border:none; background: none;">Boundary stroke:</label>
          <input id="boundary-spinner" style="width: 3em" />
        </p>
        <p style="display: flex; align-items: center">
          <label for="black-1-colorpicker" class="ui-widget ui-state-default"
            style="border:none; background: none;">Black grad-1:&nbsp;</label>
          <input type='text' id='black-1-colorpicker' class="ui-widget colorpicker" />
        </p>
        <p style="display: flex; align-items: center">
          <label for="black-2-colorpicker" class="ui-widget ui-state-default"
            style="border:none; background: none;">Black grad-2:&nbsp;</label>
          <input type='text' id='black-2-colorpicker' class="ui-widget colorpicker" />
        </p>
        <p style="display: flex; align-items: center">
          <label for="black-s-colorpicker" class="ui-widget ui-state-default"
            style="border:none; background: none;">Black stroke:&nbsp;</label>
          <input type='text' id='black-s-colorpicker' class="ui-widget colorpicker" />
        </p>
        <p style="display: flex; align-items: center">
          <label for="white-1-colorpicker" class="ui-widget ui-state-default"
            style="border:none; background: none;">White grad-1:&nbsp;</label>
          <input type='text' id='white-1-colorpicker' class="ui-widget colorpicker" />
        </p>
        <p style="display: flex; align-items: center">
          <label for="white-2-colorpicker" class="ui-widget ui-state-default"
            style="border:none; background: none;">White grad-2:&nbsp;</label>
          <input type='text' id='white-2-colorpicker' class="ui-widget colorpicker" />
        </p>
        <p style="display: flex; align-items: center">
          <label for="white-s-colorpicker" class="ui-widget ui-state-default"
            style="border:none; background: none;">White stroke:&nbsp;</label>
          <input type='text' id='white-s-colorpicker' class="ui-widget colorpicker" />
        </p>
        <p>
          <button id="download-button">Download!</button>
        </p>
      </td>
    </tr>
  </table>
</body>

</html>